// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
  MITRA
}

enum MitraStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole     @default(CUSTOMER)
  phone         String?
  isActive      Boolean      @default(true)
  mitraStatus   MitraStatus? // Only for MITRA role, null for others
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  technician    Technician?
  mitra         Mitra?
  carts         Cart[]
  orders        Order[]
  reviews       Review[]
  chats         Chat[]
  messages      Message[]
  notifications Notification[]
  tickets       Ticket[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// TECHNICIANS
// ============================================

model Technician {
  id          String   @id @default(cuid())
  userId      String   @unique
  bio         String?
  experience  Int      @default(0) // in years
  specialties String[] // e.g., ["LCD", "Mesin", "Software"]
  rating      Float    @default(0)
  totalReview Int      @default(0)
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  services Service[]
  orders   Order[]

  @@index([userId])
  @@index([rating])
  @@map("technicians")
}

// ============================================
// SERVICES & PRODUCTS
// ============================================

enum ServiceCategory {
  KONSULTASI
  CEK_BONGKAR
  SERVIS_LENGKAP
}

model Service {
  id           String          @id @default(cuid())
  technicianId String
  name         String
  description  String?
  category     ServiceCategory
  price        Float
  duration     Int? // in minutes
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  technician    Technician  @relation(fields: [technicianId], references: [id], onDelete: Cascade)
  cartItems     CartItem[]  @relation("CartItemToService")
  orderItems    OrderItem[] @relation("OrderItemToService")

  @@index([technicianId])
  @@index([category])
  @@map("services")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String // e.g., "LCD", "Baterai", "Kamera"
  brand       String?
  model       String?
  price       Float
  stock       Int      @default(0)
  images      String[] // URLs
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  cartItems  CartItem[]  @relation("CartItemToProduct")
  orderItems OrderItem[] @relation("OrderItemToProduct")

  @@index([category])
  @@index([stock])
  @@map("products")
}

model RentalItem {
  id          String   @id @default(cuid())
  name        String
  description String?
  pricePerDay Float
  stock       Int      @default(0)
  images      String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  cartItems  CartItem[]  @relation("CartItemToRental")
  orderItems OrderItem[] @relation("OrderItemToRental")

  @@index([stock])
  @@map("rental_items")
}

// ============================================
// CART & ORDERS
// ============================================

model Cart {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@index([userId])
  @@map("carts")
}

enum CartItemType {
  SERVICE
  PRODUCT
  RENTAL
}

model CartItem {
  id           String       @id @default(cuid())
  cartId       String
  type         CartItemType
  serviceId    String?
  productId    String?
  rentalItemId String?
  quantity     Int          @default(1)
  rentalDays   Int? // for rental items
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  cart       Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade)
  service    Service?    @relation("CartItemToService", fields: [serviceId], references: [id])
  product    Product?    @relation("CartItemToProduct", fields: [productId], references: [id])
  rentalItem RentalItem? @relation("CartItemToRental", fields: [rentalItemId], references: [id])

  @@index([cartId])
  @@map("cart_items")
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Order {
  id           String      @id @default(cuid())
  orderNumber  String      @unique
  userId       String
  technicianId String?
  status       OrderStatus @default(PENDING_PAYMENT)
  subtotal     Float
  tax          Float       @default(0)
  total        Float
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  user       User        @relation(fields: [userId], references: [id])
  technician Technician? @relation(fields: [technicianId], references: [id])
  items      OrderItem[]
  payment    Payment?
  invoice    Invoice?
  warranty   Warranty?
  reviews    Review[]
  tickets    Ticket[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id           String       @id @default(cuid())
  orderId      String
  type         CartItemType
  serviceId    String?
  productId    String?
  rentalItemId String?
  quantity     Int          @default(1)
  rentalDays   Int?
  price        Float
  subtotal     Float
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  order      Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  service    Service?    @relation("OrderItemToService", fields: [serviceId], references: [id])
  product    Product?    @relation("OrderItemToProduct", fields: [productId], references: [id])
  rentalItem RentalItem? @relation("OrderItemToRental", fields: [rentalItemId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// ============================================
// PAYMENT & INVOICES
// ============================================

enum PaymentMethod {
  MANUAL_TRANSFER
  MIDTRANS
}

enum PaymentStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Payment {
  id            String        @id @default(cuid())
  orderId       String        @unique
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  amount        Float
  bankAccountId String?
  proofImage    String? // URL to uploaded proof
  verifiedBy    String? // Admin user ID
  verifiedAt    DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id])

  @@index([orderId])
  @@index([status])
  @@map("payments")
}

enum BankAccountCategory {
  JASA
  SEWA
  SPAREPART
}

model BankAccount {
  id            String              @id @default(cuid())
  category      BankAccountCategory
  bankName      String
  accountNumber String
  accountName   String
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // Relations
  payments Payment[]

  @@map("bank_accounts")
}

model Invoice {
  id          String   @id @default(cuid())
  orderId     String   @unique
  invoiceNumber String @unique
  pdfUrl      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([invoiceNumber])
  @@map("invoices")
}

// ============================================
// WARRANTY & TICKETS
// ============================================

model Warranty {
  id         String    @id @default(cuid())
  orderId    String    @unique
  startDate  DateTime  @default(now())
  endDate    DateTime
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tickets Ticket[]

  @@index([orderId])
  @@index([endDate])
  @@map("warranties")
}

enum TicketStatus {
  OPEN
  PENDING_APPROVAL
  APPROVED
  REJECTED
  RESOLVED
  CLOSED
}

model Ticket {
  id          String       @id @default(cuid())
  orderId     String
  warrantyId  String?
  userId      String
  subject     String
  description String
  status      TicketStatus @default(OPEN)
  resolvedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  order    Order     @relation(fields: [orderId], references: [id])
  warranty Warranty? @relation(fields: [warrantyId], references: [id])
  user     User      @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("tickets")
}

// ============================================
// MITRA (PARTNERS)
// ============================================

model Mitra {
  id          String   @id @default(cuid())
  userId      String   @unique
  businessName String
  description String?
  address     String
  city        String
  province    String
  latitude    Float?
  longitude   Float?
  phone       String
  whatsapp    String?
  rating      Float    @default(0)
  totalReview Int      @default(0)
  isApproved  Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  services  MitraService[]
  images    MitraImage[]
  schedules MitraSchedule[]
  reviews   Review[]

  @@index([userId])
  @@index([city])
  @@index([isApproved])
  @@map("mitras")
}

model MitraService {
  id          String   @id @default(cuid())
  mitraId     String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  mitra Mitra @relation(fields: [mitraId], references: [id], onDelete: Cascade)

  @@index([mitraId])
  @@map("mitra_services")
}

model MitraImage {
  id        String   @id @default(cuid())
  mitraId   String
  url       String
  isBanner  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mitra Mitra @relation(fields: [mitraId], references: [id], onDelete: Cascade)

  @@index([mitraId])
  @@map("mitra_images")
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model MitraSchedule {
  id        String    @id @default(cuid())
  mitraId   String
  day       DayOfWeek
  openTime  String // HH:mm format
  closeTime String // HH:mm format
  isClosed  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  mitra Mitra @relation(fields: [mitraId], references: [id], onDelete: Cascade)

  @@index([mitraId])
  @@map("mitra_schedules")
}

// ============================================
// REVIEWS
// ============================================

enum ReviewType {
  TECHNICIAN
  PRODUCT
  RENTAL
  MITRA
}

model Review {
  id          String     @id @default(cuid())
  userId      String
  orderId     String?
  mitraId     String?
  type        ReviewType
  rating      Int // 1-5
  comment     String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])
  mitra Mitra? @relation(fields: [mitraId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@index([mitraId])
  @@map("reviews")
}

// ============================================
// CHAT & MESSAGES
// ============================================

model Chat {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id])
  messages Message[]

  @@index([userId])
  @@map("chats")
}

model Message {
  id         String   @id @default(cuid())
  chatId     String
  senderId   String
  content    String
  fileUrl    String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id])

  @@index([chatId])
  @@index([senderId])
  @@map("messages")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  ORDER_CREATED
  PAYMENT_VERIFIED
  ORDER_STATUS_CHANGED
  NEW_MESSAGE
  NEW_REVIEW
  MITRA_APPROVED
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// ============================================
// BLOG/ARTICLES
// ============================================

model Article {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  excerpt     String?
  content     String
  coverImage  String?
  category    String?
  tags        String[]
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@map("articles")
}
