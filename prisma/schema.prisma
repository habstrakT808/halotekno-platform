generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  name          String?
  email         String         @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole       @default(CUSTOMER)
  phone         String?
  isActive      Boolean        @default(true)
  mitraStatus   MitraStatus?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  accounts      Account[]
  carts         Cart[]
  chats         chats[]
  messages      messages[]
  mitra         Mitra?
  notifications Notification[]
  orders        Order[]
  reviews       Review[]
  sessions      Session[]
  technician    Technician?
  tickets       Ticket[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

model Technician {
  id          String    @id @default(cuid())
  userId      String    @unique
  bio         String?
  experience  Int       @default(0)
  specialties String[]
  rating      Float     @default(0)
  totalReview Int       @default(0)
  isAvailable Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  orders      Order[]
  services    Service[]
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([rating])
  @@map("technicians")
}

model Service {
  id           String          @id @default(cuid())
  technicianId String
  name         String
  description  String?
  category     ServiceCategory
  price        Float
  duration     Int?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  cartItems    CartItem[]      @relation("CartItemToService")
  orderItems   OrderItem[]     @relation("OrderItemToService")
  technician   Technician      @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([technicianId])
  @@index([category])
  @@map("services")
}

model Product {
  id          String      @id @default(cuid())
  name        String
  description String?
  category    String
  brand       String?
  model       String?
  price       Float
  stock       Int         @default(0)
  images      String[]
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  cartItems   CartItem[]  @relation("CartItemToProduct")
  orderItems  OrderItem[] @relation("OrderItemToProduct")

  @@index([category])
  @@index([stock])
  @@map("products")
}

model RentalItem {
  id          String      @id @default(cuid())
  name        String
  description String?
  pricePerDay Float
  stock       Int         @default(0)
  images      String[]
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  cartItems   CartItem[]  @relation("CartItemToRental")
  orderItems  OrderItem[] @relation("OrderItemToRental")

  @@index([stock])
  @@map("rental_items")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("carts")
}

model CartItem {
  id           String       @id @default(cuid())
  cartId       String
  type         CartItemType
  serviceId    String?
  productId    String?
  rentalItemId String?
  quantity     Int          @default(1)
  rentalDays   Int?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  cart         Cart         @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product      Product?     @relation("CartItemToProduct", fields: [productId], references: [id])
  rentalItem   RentalItem?  @relation("CartItemToRental", fields: [rentalItemId], references: [id])
  service      Service?     @relation("CartItemToService", fields: [serviceId], references: [id])

  @@index([cartId])
  @@map("cart_items")
}

model Order {
  id           String      @id @default(cuid())
  orderNumber  String      @unique
  userId       String
  technicianId String?
  status       OrderStatus @default(PENDING_PAYMENT)
  subtotal     Float
  tax          Float       @default(0)
  total        Float
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  invoice      Invoice?
  items        OrderItem[]
  technician   Technician? @relation(fields: [technicianId], references: [id])
  user         User        @relation(fields: [userId], references: [id])
  payment      Payment?
  reviews      Review[]
  tickets      Ticket[]
  warranty     Warranty?

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id           String       @id @default(cuid())
  orderId      String
  type         CartItemType
  serviceId    String?
  productId    String?
  rentalItemId String?
  quantity     Int          @default(1)
  rentalDays   Int?
  price        Float
  subtotal     Float
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product?     @relation("OrderItemToProduct", fields: [productId], references: [id])
  rentalItem   RentalItem?  @relation("OrderItemToRental", fields: [rentalItemId], references: [id])
  service      Service?     @relation("OrderItemToService", fields: [serviceId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id            String        @id @default(cuid())
  orderId       String        @unique
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  amount        Float
  bankAccountId String?
  proofImage    String?
  verifiedBy    String?
  verifiedAt    DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  bankAccount   BankAccount?  @relation(fields: [bankAccountId], references: [id])
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("payments")
}

model BankAccount {
  id            String              @id @default(cuid())
  category      BankAccountCategory
  bankName      String
  accountNumber String
  accountName   String
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  payments      Payment[]

  @@map("bank_accounts")
}

model Invoice {
  id            String   @id @default(cuid())
  orderId       String   @unique
  invoiceNumber String   @unique
  pdfUrl        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([invoiceNumber])
  @@map("invoices")
}

model Warranty {
  id        String   @id @default(cuid())
  orderId   String   @unique
  startDate DateTime @default(now())
  endDate   DateTime
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tickets   Ticket[]
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([endDate])
  @@map("warranties")
}

model Ticket {
  id          String       @id @default(cuid())
  orderId     String
  warrantyId  String?
  userId      String
  subject     String
  description String
  status      TicketStatus @default(OPEN)
  resolvedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  order       Order        @relation(fields: [orderId], references: [id])
  user        User         @relation(fields: [userId], references: [id])
  warranty    Warranty?    @relation(fields: [warrantyId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("tickets")
}

model Mitra {
  id             String          @id @default(cuid())
  userId         String          @unique
  businessName   String
  tagline        String?
  description    String?
  banner         String?
  address        String
  city           String
  province       String
  latitude       Float?
  longitude      Float?
  phone          String
  whatsapp       String?
  email          String?
  website        String?
  features       String[]
  weekdayHours   String?
  weekendHours   String?
  rating         Float           @default(0)
  totalReview    Int             @default(0)
  totalViews     Int             @default(0)
  totalInquiries Int             @default(0)
  isApproved     Boolean         @default(false)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  images         MitraImage[]
  schedules      MitraSchedule[]
  services       MitraService[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews        Review[]

  @@index([userId])
  @@index([city])
  @@index([isApproved])
  @@map("mitras")
}

model MitraService {
  id          String   @id @default(cuid())
  mitraId     String
  name        String
  description String?
  icon        String?
  price       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  mitra       Mitra    @relation(fields: [mitraId], references: [id], onDelete: Cascade)

  @@index([mitraId])
  @@map("mitra_services")
}

model MitraImage {
  id        String   @id @default(cuid())
  mitraId   String
  url       String
  isBanner  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mitra     Mitra    @relation(fields: [mitraId], references: [id], onDelete: Cascade)

  @@index([mitraId])
  @@map("mitra_images")
}

model MitraSchedule {
  id        String    @id @default(cuid())
  mitraId   String
  day       DayOfWeek
  openTime  String
  closeTime String
  isClosed  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  mitra     Mitra     @relation(fields: [mitraId], references: [id], onDelete: Cascade)

  @@index([mitraId])
  @@map("mitra_schedules")
}

model Review {
  id        String     @id @default(cuid())
  userId    String
  orderId   String?
  mitraId   String?
  type      ReviewType
  rating    Int
  comment   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  mitra     Mitra?     @relation(fields: [mitraId], references: [id])
  order     Order?     @relation(fields: [orderId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@index([mitraId])
  @@map("reviews")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model Article {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  excerpt     String?
  content     String
  coverImage  String?
  category    String?
  tags        String[]
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@map("articles")
}

model chats {
  id        String     @id
  userId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime
  users     User       @relation(fields: [userId], references: [id])
  messages  messages[]

  @@index([userId])
}

model messages {
  id        String   @id
  chatId    String
  senderId  String
  content   String
  fileUrl   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
  chats     chats    @relation(fields: [chatId], references: [id], onDelete: Cascade)
  users     User     @relation(fields: [senderId], references: [id])

  @@index([chatId])
  @@index([senderId])
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
  MITRA
}

enum MitraStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ServiceCategory {
  KONSULTASI
  CEK_BONGKAR
  SERVIS_LENGKAP
}

enum CartItemType {
  SERVICE
  PRODUCT
  RENTAL
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  MANUAL_TRANSFER
  MIDTRANS
}

enum PaymentStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum BankAccountCategory {
  JASA
  SEWA
  SPAREPART
}

enum TicketStatus {
  OPEN
  PENDING_APPROVAL
  APPROVED
  REJECTED
  RESOLVED
  CLOSED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ReviewType {
  TECHNICIAN
  PRODUCT
  RENTAL
  MITRA
}

enum NotificationType {
  ORDER_CREATED
  PAYMENT_VERIFIED
  ORDER_STATUS_CHANGED
  NEW_MESSAGE
  NEW_REVIEW
  MITRA_APPROVED
}
